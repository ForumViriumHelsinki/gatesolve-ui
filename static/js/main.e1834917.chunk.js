(this["webpackJsonpgatesolve-ui"]=this["webpackJsonpgatesolve-ui"]||[]).push([[0],{229:function(t,e,n){t.exports=n(412)},234:function(t,e,n){},238:function(t,e,n){},280:function(t,e){},282:function(t,e){},313:function(t,e){},318:function(t,e){},328:function(t,e){},329:function(t,e){},408:function(t,e,n){},412:function(t,e,n){"use strict";n.r(e);var o,a=n(2),r=n.n(a),i=n(222),c=n.n(i),l=n(157),s=(n(234),n(23)),u=n(47),p=n(75),d=n(74),f=n(34),g=(n(237),n(224)),m={id:"route-line",type:"line",paint:{"line-opacity":["coalesce",["get","opacity"],.5],"line-width":5,"line-color":["get","color"]}},h={id:"route-point",type:"circle",paint:{"circle-opacity":["coalesce",["get","opacity"],1],"circle-radius":5,"circle-color":["get","color"]},filter:["==","Point",["geometry-type"]]},v={id:"entrance-point","source-layer":"osm",type:"circle",minzoom:12,maxzoom:15.99999,paint:{"circle-radius":["interpolate",["linear"],["zoom"],12,1,14,3,15,5],"circle-color":"#64be14"},filter:["has","entrance"]},b={id:"entrance-symbol","source-layer":"osm",type:"symbol",minzoom:16,paint:{"text-color":"#fff","text-halo-color":"#64be14","text-halo-width":3},layout:{"text-field":["coalesce",["get","ref"],["get","addr:unit"]],"text-anchor":"center","text-font":["Klokantech Noto Sans Regular"],"text-size":24,"text-offset":[0,-1.3],"icon-image":"icon-pin-48-#64be14-#fff","icon-anchor":"bottom","icon-allow-overlap":!0,"text-allow-overlap":!0},filter:["has","entrance"]},y={id:"route-point-symbol",type:"symbol",paint:{"text-color":"#000","text-halo-color":"#fff","text-halo-width":3},layout:{"text-field":["get","ref"],"text-anchor":"center","text-font":["Klokantech Noto Sans Regular"],"text-size":24,"text-offset":[0,-.05]},filter:["==","Point",["geometry-type"]]},O=n(228),w="M7.5 0C5.068 0 2.23 1.486 2.23 5.27c0 2.568 4.054 8.244 5.27 9.73c1.081-1.486 5.27-7.027 5.27-9.73C12.77 1.487 9.932 0 7.5 0z",E=function(t){var e=t.height,n=void 0===e?"50":e,o=t.style,a=void 0===o?{fill:"#444",stroke:"none"}:o,i=t.dataTestId;return(r.a.createElement("svg",{"data-testid":i,height:n,style:a,viewBox:"-1 -1 17 17",pointerEvents:"none"},r.a.createElement("path",{d:w,pointerEvents:"visiblepainted",cursor:"pointer"})))},j=(n(238),function(t){var e=t.pin,n=e.height,o=void 0===n?"50":n,a=Object(O.a)(e,["height"]),i=t.marker;return(r.a.createElement(f.c,Object.assign({},i,{offsetLeft:-o/2,offsetTop:-o,className:"PinMarker"}),r.a.createElement(E,Object(s.a)({height:o},a))))}),x=n(5),L=n.n(x),S=n(225),T=n(13),k=n(12),P=n(27),R=n(28),M=(n(111),n(72)),C=n(10),N=n.n(C),I=n(37),z=n.n(I),_=n(25),A=n.n(_),D=n(108),F=n.n(D),B=(null===(o=Object({NODE_ENV:"production",PUBLIC_URL:"/gatesolve-ui",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0}).REACT_APP_ROUTABLE_TILES)||void 0===o?void 0:o.replace(/\/$/,""))||"https://tile.olmap.org/routable-tiles",K=function(t){Object(R.a)(n,t);var e=Object(P.a)(n);function n(){return Object(T.a)(this,n),e.apply(this,arguments)}return Object(k.a)(n,[{key:"getIdForTileCoords",value:function(t){return"".concat(B,"/").concat(t.zoom,"/").concat(t.x,"/").concat(t.y)}}]),n}(z.a);F.a.unbind(N.a.RoutableTileProvider),F.a.bind(N.a.RoutableTileProvider).to(K).inSingletonScope().whenTargetTagged("phase",A.a.Base),F.a.bind(N.a.RoutableTileProvider).to(K).inSingletonScope().whenTargetTagged("phase",A.a.Transit);var U=M.FlexibleRoadPlanner;function q(t){var e=[],n=[],o=new Map;return t.legs[0].getSteps().forEach((function(a){var r,i,c=a.stopLocation;"https://w3id.org/openstreetmap/terms#Steps"===(null===(r=t.context[a.through])||void 0===r?void 0:r.definedTags["https://w3id.org/openstreetmap/terms#highway"])&&(o.has(a.through)||o.set(a.through,[]),o.get(a.through).push([a.startLocation.longitude,a.startLocation.latitude],[a.stopLocation.longitude,a.stopLocation.latitude])),(null===(i=c.definedTags)||void 0===i?void 0:i["https://w3id.org/openstreetmap/terms#barrier"])&&(console.log(a.through,c.definedTags["https://w3id.org/openstreetmap/terms#barrier"].replace(/^.*#/,""),c.id,c.definedTags,c.freeformTags),n.push([c.longitude,c.latitude])),e.push([a.startLocation.longitude,a.startLocation.latitude]),e.push([a.stopLocation.longitude,a.stopLocation.latitude])})),[e,n,Array.from(o.values())]}function W(t,e,n,o,a,r){var i=[];return t&&i.push({type:"Feature",geometry:{type:"Point",coordinates:[t[1],t[0]]},properties:{color:"#00afff"}}),e&&e.forEach((function(t){i.push({type:"Feature",geometry:{type:"Point",coordinates:[t.lon,t.lat]},properties:{color:"#64be14"}})})),n&&n.forEach((function(t){var e,n;i.push({type:"Feature",geometry:{type:"Point",coordinates:[t.lon,t.lat]},properties:{color:"#00ffff",ref:(null===(e=t.tags)||void 0===e?void 0:e.ref)||(null===(n=t.tags)||void 0===n?void 0:n["addr:unit"]),opacity:0}})})),o&&i.push({type:"Feature",geometry:{type:"LineString",coordinates:o},properties:{color:"#000"}}),r&&i.push({type:"Feature",geometry:{type:"MultiLineString",coordinates:r},properties:{color:"#dc0451",opacity:1}}),a&&i.push({type:"Feature",geometry:{type:"MultiPoint",coordinates:a},properties:{color:"#dc0451",ref:"!"}}),{type:"FeatureCollection",features:i}}n(408);var H=function(t){return{id:-1,type:"node",lat:t[0],lon:t[1]}},G={origin:[60.16295,24.93071],destination:H([60.16259,24.93155]),entrances:[],route:W(),viewport:{latitude:60.163,longitude:24.931,zoom:16,bearing:0,pitch:0}},J=function(t){if(!t)throw Error("This cannot happen as URL isn't actually optional.");return{url:t.replace("https://static.hsldev.com/mapfonts/Klokantech Noto Sans","https://fonts.openmaptiles.org/Klokantech Noto Sans")}},V=function(t){return t.split(",").map(Number)},$=function(t,e){var n=new f.e(t),o=Math.min.apply(Math,Object(p.a)(e.map((function(t){return t[1]})))),a=Math.max.apply(Math,Object(p.a)(e.map((function(t){return t[1]})))),r=Math.min.apply(Math,Object(p.a)(e.map((function(t){return t[0]})))),i=Math.max.apply(Math,Object(p.a)(e.map((function(t){return t[0]}))));return n.fitBounds([[o,r],[a,i]],{padding:{top:110,bottom:25,left:45,right:45}})},Q=function(){var t=Object(a.useRef)(null),e=Object(a.useRef)({}),n=Object(a.useRef)(null);Object(a.useEffect)((function(){if(t.current){var e=t.current.getMap();null===e||void 0===e||e.on("styleimagemissing",(function(t){var n=t.id;if(n.startsWith("icon-pin-")){var o=n.split("-"),a=Object(u.a)(o,5),r=a[2],i=a[3],c=a[4],l=function(t,e){return'\n<svg xmlns="http://www.w3.org/2000/svg"\n  width="'.concat(t,'px"\n  height="').concat(t,'px"\n  style="').concat(e,'"\n  viewBox="').concat("-1 -1 17 17",'"\n>\n  <path d="').concat(w,'" />\n</svg>')}(r,"fill: ".concat(i,"; stroke: ").concat(c));!function(t,e,n,o){var a=window.devicePixelRatio,r=document.createElement("canvas");r.width=a*o,r.height=a*o;var i=r.getContext("2d"),c=new Image(o,o),l="data:image/svg+xml,".concat(encodeURIComponent(n));c.onload=function(){if(!i)throw Error("canvas.getContext failed");i.drawImage(c,0,0,a*o,a*o),t.addImage(e,i.getImageData(0,0,a*o,a*o),{pixelRatio:a})},c.src=l}(e,n,l,r)}}))}}),[t]);var o=Object(d.e)({path:"/route/:from/:to"}),i=Object(a.useState)(G),c=Object(u.a)(i,2),l=c[0],O=c[1];Object(a.useEffect)((function(){if(o){var t=V(o.params.from),n=V(o.params.to),a=$(e.current,[t,n]);O((function(o){return Object(s.a)({},o,{origin:t,destination:H(n),viewport:Object(s.a)({},e.current,{},a)})}))}}),[]);var E=Object(d.d)();return Object(a.useEffect)((function(){var t=[l.destination.lat,l.destination.lon];E.location.pathname!=="/route/".concat(l.origin,"/").concat(t,"/")&&E.replace("/route/".concat(l.origin,"/").concat(t,"/"))}),[E,l.origin,l.destination]),Object(a.useEffect)((function(){(function(t){var e,n,o=new URL("https://overpass-api.de/api/interpreter");return o.searchParams.append("data",(e=t.lat,n=t.lon,"\n  [out:json][timeout:25];\n  (\n    relation(around:10, ".concat(e,", ").concat(n,")[building];\n    way(r);\n    way(around:10, ").concat(e,", ").concat(n,")[building];\n  )->.b;\n  // gather results\n  (\n    node(w.b)[entrance];\n  );\n  // print results\n  out body;\n  >;\n  out skel qt;\n"))),fetch(o.toString()).then((function(t){return t.json().then((function(t){return t.elements.filter((function(t){return"node"===t.type&&"lat"in t&&null!=t.lat&&"lon"in t&&null!=t.lon&&t.tags&&t.tags.entrance}))}))}))})(l.destination).then((function(t){O((function(e){if(e.destination!==l.destination)return e;var n=t.length?t:[l.destination];return Object(s.a)({},e,{entrances:n})}))}))}),[l.destination]),Object(a.useEffect)((function(){var t=[];l.entrances.forEach((function(e){l.destination.type===e.type&&l.destination.id===e.id&&(t=[e])})),t.length||(t=l.entrances),O((function(t){return Object(s.a)({},t,{route:W()})})),function(t,e,n){e.forEach((function(e){var o=new U;o.setProfileID("".concat("https","://").concat("/gatesolve-ui","/delivery.json")).query({from:{latitude:t[0],longitude:t[1]},to:{latitude:e.lat,longitude:e.lon}}).take(1).on("data",function(){var a=Object(S.a)(L.a.mark((function a(r){var i,c,l,s,p,d,f;return L.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,o.completePath(r);case 2:i=a.sent,console.log("Plan",i,"from",t,"to",e),c=q(i),l=Object(u.a)(c,3),s=l[0],p=l[1],d=l[2],f=W(t,[e],void 0,s,p,d),n(f);case 7:case"end":return a.stop()}}),a)})));return function(t){return a.apply(this,arguments)}}())}))}(l.origin,t,(function(t){O((function(e){var n;return l.origin!==e.origin||l.entrances!==e.entrances||l.destination!==e.destination?e:((n=t.features).push.apply(n,Object(p.a)(e.route.features)),Object(s.a)({},e,{route:t}))}))}))}),[l.origin,l.entrances]),r.a.createElement("div",{"data-testid":"app",className:"App"},r.a.createElement("header",{className:"App-header"},r.a.createElement("h2",null,"Gatesolve")),r.a.createElement(g.ReactAutosuggestGeocoder,{url:"https://api.digitransit.fi/geocoding/v1/",sources:"oa,osm,nlsfi",onSuggestionSelected:function(t,n){var o=n.suggestion,a=l.origin,r=[o.geometry.coordinates[1],o.geometry.coordinates[0]],i=$(e.current,[a,r]),c=o.properties.source_id.split(":"),p=Object(u.a)(c,2),d=p[0],f=p[1];O((function(t){return Object(s.a)({},t,{origin:a,destination:{lat:r[0],lon:r[1],type:d,id:Number(f)},entrances:[],viewport:Object(s.a)({},e.current,{},i)})}))}}),r.a.createElement(f.f,Object.assign({ref:t},l.viewport,{width:"100%",height:"90%",mapStyle:"https://raw.githubusercontent.com/HSLdevcom/hsl-map-style/master/simple-style.json",transformRequest:J,onViewportChange:function(t){e.current=t,O((function(e){return Object(s.a)({},e,{viewport:t})}))},onHover:function(t){var e,n=null===(e=t.features)||void 0===e?void 0:e[0],o=(null===n||void 0===n?void 0:n.properties.entrance)?"pointer":"grab",a=document.querySelector(".overlays");a&&(a.style.cursor=o)},onClick:function(t){if(0===t.srcEvent.button&&"mapboxgl-ctrl-icon"!==t.target.className&&"mapboxgl-ctrl mapboxgl-ctrl-attrib mapboxgl-compact"!==t.target.className){var e=t.features[0];(null===e||void 0===e?void 0:e.properties.entrance)?O((function(t){return Object(s.a)({},t,{destination:{id:e.properties["@id"],type:e.properties["@type"],lat:e.geometry.coordinates[1],lon:e.geometry.coordinates[0]}})})):O((function(e){return Object(s.a)({},e,{destination:H([t.lngLat[1],t.lngLat[0]])})}))}},onContextMenu:function(t){O((function(e){return Object(s.a)({},e,{origin:[t.lngLat[1],t.lngLat[0]]})})),t.srcEvent.preventDefault()}}),r.a.createElement(f.a,{className:"mapboxgl-ctrl-bottom-left",positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0,onGeolocate:function(t){(null===n.current||t.timestamp-n.current>1e4)&&(n.current=t.timestamp,O((function(e){return Object(s.a)({},e,{origin:[t.coords.latitude,t.coords.longitude]})})))}}),r.a.createElement(f.d,{id:"osm-qa-tiles",type:"vector",tiles:["https://tile.olmap.org/osm-qa-tiles/{z}/{x}/{y}.pbf"],minzoom:12,maxzoom:12},r.a.createElement(f.b,v),r.a.createElement(f.b,b)),r.a.createElement(f.d,{type:"geojson",data:l.route},r.a.createElement(f.b,m),r.a.createElement(f.b,h),r.a.createElement(f.b,y)),r.a.createElement(j,{marker:{draggable:!0,onDragEnd:function(t){O((function(e){return Object(s.a)({},e,{origin:[t.lngLat[1],t.lngLat[0]]})}))},longitude:l.origin[1],latitude:l.origin[0]},pin:{dataTestId:"origin",style:{fill:"#00afff",stroke:"#fff"}}}),r.a.createElement(j,{marker:{draggable:!0,onDragEnd:function(t){O((function(e){return Object(s.a)({},e,{destination:H([t.lngLat[1],t.lngLat[0]])})}))},longitude:l.destination.lon,latitude:l.destination.lat},pin:{dataTestId:"destination",style:{fill:"#64be14",stroke:"#fff"}}})))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));c.a.render(r.a.createElement(r.a.StrictMode,null,r.a.createElement(l.a,null,r.a.createElement(Q,null))),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(t){t.unregister()})).catch((function(t){console.error(t.message)}))}},[[229,1,2]]]);
//# sourceMappingURL=main.e1834917.chunk.js.map