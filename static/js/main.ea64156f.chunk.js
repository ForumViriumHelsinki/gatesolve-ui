(this["webpackJsonpgatesolve-ui"]=this["webpackJsonpgatesolve-ui"]||[]).push([[0],{220:function(t,e,o){t.exports=o(404)},225:function(t,e,o){},269:function(t,e){},271:function(t,e){},302:function(t,e){},307:function(t,e){},317:function(t,e){},318:function(t,e){},397:function(t,e,o){},398:function(t,e,o){},404:function(t,e,o){"use strict";o.r(e);var n,a=o(0),i=o.n(a),r=o(102),c=o.n(r),l=o(151),s=(o(225),o(14)),u=o(24),d=o(84),p=o(68),g=o(30),f=o(219),m=(o(227),o(215)),v={id:"route-line",type:"line",layout:{"line-cap":"round","line-join":"round"},paint:{"line-opacity":["coalesce",["get","opacity"],.5],"line-width":5,"line-color":["get","color"]},filter:["!",["coalesce",["get","imaginary"],!1]]},h={id:"route-imaginary-line",type:"line",layout:{"line-cap":"round","line-join":"round"},paint:{"line-opacity":["coalesce",["get","opacity"],.5],"line-width":5,"line-color":["get","color"],"line-dasharray":[0,2]},filter:["coalesce",["get","imaginary"],!1]},b={id:"route-point",type:"circle",paint:{"circle-opacity":["coalesce",["get","opacity"],1],"circle-radius":5,"circle-color":["get","color"]},filter:["==","Point",["geometry-type"]]},y={id:"entrance-point",type:"circle",minzoom:12,maxzoom:15.99999,paint:{"circle-radius":["interpolate",["linear"],["zoom"],12,1,14,3,15,5],"circle-color":"#64be14"},filter:["has","entrance"]},O={id:"entrance-symbol",type:"symbol",minzoom:16,paint:{"text-color":"#fff","text-halo-color":"#64be14","text-halo-width":3},layout:{"text-field":["coalesce",["get","ref"],["get","addr:unit"]],"text-anchor":"center","text-font":["Klokantech Noto Sans Regular"],"text-size":24,"text-offset":[0,-1.3],"icon-image":"icon-pin-48-#64be14-#fff","icon-anchor":"bottom","icon-allow-overlap":!0,"text-allow-overlap":!0},filter:["has","entrance"]},w={id:"route-point-symbol",type:"symbol",paint:{"text-color":"#000","text-halo-color":"#fff","text-halo-width":3},layout:{"text-field":["get","ref"],"text-anchor":"center","text-font":["Klokantech Noto Sans Regular"],"text-size":24,"text-offset":[0,-.05]},filter:["==","Point",["geometry-type"]]},j="M7.5 0C5.068 0 2.23 1.486 2.23 5.27c0 2.568 4.054 8.244 5.27 9.73c1.081-1.486 5.27-7.027 5.27-9.73C12.77 1.487 9.932 0 7.5 0z",E=function(t){var e=t.height,o=void 0===e?"50":e,n=t.style,a=void 0===n?{fill:"#444",stroke:"none"}:n,r=t.dataTestId;return(i.a.createElement("svg",{"data-testid":r,height:o,style:a,viewBox:"-1 -1 17 17",pointerEvents:"none"},i.a.createElement("path",{d:j,pointerEvents:"visiblepainted",cursor:"pointer"})))},x=function(t){var e=t.dataTestId,o=t.width,n=void 0===o?"40":o,a=t.height,r=void 0===a?"40":a,c=t.stroke,l=void 0===c?"#00afff":c,s=t.strokeWidth,u=void 0===s?"16":s;return(i.a.createElement("svg",{"data-testid":e,width:n,height:r,stroke:l,strokeWidth:u,viewBox:"-100 -100 200 200",fill:"transparent",style:{position:"absolute"}},i.a.createElement("circle",{cx:"0",cy:"0",r:"24"}),i.a.createElement("circle",{cx:"0",cy:"0",r:"46"}),i.a.createElement("circle",{cx:"0",cy:"0",r:"68"})))},S=function(t){var e=t.dataTestId,o=t.onGeolocate,n=t.onGeolocateError,r=t.positionOptions,c=void 0===r?{enableHighAccuracy:!0,timeout:6e3}:r,l=t.onEnable,s=t.onDisable,d=t.enableOnMount,p=void 0===d||d,g=Object(a.useState)(null!=window.navigator.geolocation),f=Object(u.a)(g,1)[0],m=Object(a.useState)(null!=window.navigator.permissions),v=Object(u.a)(m,1)[0],h=Object(a.useState)(null),b=Object(u.a)(h,2),y=b[0],O=b[1],w=Object(a.useState)(null),j=Object(u.a)(w,2),E=j[0],x=j[1],S=Object(a.useState)(!1),T=Object(u.a)(S,2),P=T[0],L=T[1],k=function(){f&&null==E&&(x(window.navigator.geolocation.watchPosition(o,n,c)),L(!0),null!=l&&l())},M=function(){f&&null!=E&&(window.navigator.geolocation.clearWatch(E),x(null),null!=s&&s())},I=function(){console.log("Geolocation is denied. Inform the user.")};Object(a.useEffect)((function(){f||console.log("Geolocation is not supported. Inform the user.")}),[f]),Object(a.useEffect)((function(){f&&v&&null==y&&v&&window.navigator.permissions.query({name:"geolocation"}).then((function(t){O(t.state),t.onchange=function(){O(this.state)}})).catch((function(t){console.error("Permissions API exists but querying it fails:",t)}))}),[]),Object(a.useEffect)((function(){"denied"===y&&(I(),M())}),[y]);var C=!v||null!=y,R=null!=E;Object(a.useEffect)((function(){!p||P||!f||R||v&&(null==y||"denied"===y)||k()}),[p,P,f,R,v,y]);var W=null;if(f){var N=R?"Stop using my location":"Find my location",z=R?"mapboxgl-ctrl-icon mapboxgl-ctrl-geolocate mapboxgl-ctrl-geolocate-active":"mapboxgl-ctrl-icon mapboxgl-ctrl-geolocate";W=i.a.createElement("div",{className:"mapboxgl-ctrl mapboxgl-ctrl-group mapboxgl-ctrl-bottom-left"},i.a.createElement("button",{type:"button",className:z,"data-testid":e,"aria-label":N,"aria-pressed":R,onContextMenu:function(t){return t.preventDefault()},onClick:C?function(t){console.assert(f),console.assert(C),t.preventDefault(),R?M():v&&"denied"===y?I():k()}:void 0},i.a.createElement("span",{className:"mapboxgl-ctrl-icon","aria-hidden":"true"})))}return W},T=o(3),P=o.n(T),L=o(216),k=o(9),M=o(8),I=o(22),C=o(23),R=(o(106),o(66)),W=o(6),N=o.n(W),z=o(33),D=o.n(z),F=o(21),_=o.n(F),q=o(104),G=o.n(q),A=(null===(n=Object({NODE_ENV:"production",PUBLIC_URL:"/gatesolve-ui",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0}).REACT_APP_ROUTABLE_TILES)||void 0===n?void 0:n.replace(/\/$/,""))||"https://tile.olmap.org/routable-tiles",B=function(t){Object(C.a)(o,t);var e=Object(I.a)(o);function o(){return Object(k.a)(this,o),e.apply(this,arguments)}return Object(M.a)(o,[{key:"getIdForTileCoords",value:function(t){return"".concat(A,"/").concat(t.zoom,"/").concat(t.x,"/").concat(t.y)}}]),o}(D.a);G.a.unbind(N.a.RoutableTileProvider),G.a.bind(N.a.RoutableTileProvider).to(B).inSingletonScope().whenTargetTagged("phase",_.a.Base),G.a.bind(N.a.RoutableTileProvider).to(B).inSingletonScope().whenTargetTagged("phase",_.a.Transit);var K=R.FlexibleRoadPlanner;function H(t){var e=[],o=[],n=new Map,a=[];return t.legs[0].getSteps().forEach((function(i,r){var c,l;if(i.startLocation.id||i.stopLocation.id||1===r){var s=i.stopLocation;"https://w3id.org/openstreetmap/terms#Steps"===(null===(c=t.context[i.through])||void 0===c?void 0:c.definedTags["https://w3id.org/openstreetmap/terms#highway"])&&(n.has(i.through)||n.set(i.through,[]),n.get(i.through).push([i.startLocation.longitude,i.startLocation.latitude],[i.stopLocation.longitude,i.stopLocation.latitude])),(null===(l=s.definedTags)||void 0===l?void 0:l["https://w3id.org/openstreetmap/terms#barrier"])&&(console.log(i.through,s.definedTags["https://w3id.org/openstreetmap/terms#barrier"].replace(/^.*#/,""),s.id,s.definedTags,s.freeformTags),o.push([s.longitude,s.latitude])),e.push([i.startLocation.longitude,i.startLocation.latitude]),e.push([i.stopLocation.longitude,i.stopLocation.latitude])}else a.push([[i.startLocation.longitude,i.startLocation.latitude],[i.stopLocation.longitude,i.stopLocation.latitude]])})),{coordinates:e,obstacles:o,obstacleWays:Array.from(n.values()),imaginaryWays:a}}function U(t,e,o,n){var a=[];return t&&a.push({type:"Feature",geometry:{type:"Point",coordinates:[t[1],t[0]]},properties:{color:"#00afff"}}),e&&e.forEach((function(t){a.push({type:"Feature",geometry:{type:"Point",coordinates:[t.lon,t.lat]},properties:{color:"#64be14"}})})),o&&o.forEach((function(t){var e,o;a.push({type:"Feature",geometry:{type:"Point",coordinates:[t.lon,t.lat]},properties:{color:"#00ffff",ref:(null===(e=t.tags)||void 0===e?void 0:e.ref)||(null===(o=t.tags)||void 0===o?void 0:o["addr:unit"]),opacity:0}})})),(null===n||void 0===n?void 0:n.coordinates)&&a.push({type:"Feature",geometry:{type:"LineString",coordinates:n.coordinates},properties:{color:"#000"}}),(null===n||void 0===n?void 0:n.obstacleWays)&&a.push({type:"Feature",geometry:{type:"MultiLineString",coordinates:n.obstacleWays},properties:{color:"#dc0451",opacity:1}}),(null===n||void 0===n?void 0:n.imaginaryWays)&&a.push({type:"Feature",geometry:{type:"MultiLineString",coordinates:n.imaginaryWays},properties:{color:"#000",imaginary:!0}}),(null===n||void 0===n?void 0:n.obstacles)&&a.push({type:"Feature",geometry:{type:"MultiPoint",coordinates:n.obstacles},properties:{color:"#dc0451",ref:"!"}}),{type:"FeatureCollection",features:a}}o(397),o(398);var J=function(t){return{id:-1,type:"node",lat:t[0],lon:t[1]}},V={origin:[60.16295,24.93071],destination:J([60.16259,24.93155]),entrances:[],route:U(),viewport:{latitude:60.163,longitude:24.931,zoom:16,bearing:0,pitch:0},isGeolocating:!1,geolocationTimestamp:null,geolocationPosition:null},$=[60.17066815612902,24.941510260105133],Q=function(t){return{url:t.replace("https://static.hsldev.com/mapfonts/Klokantech Noto Sans","https://fonts.openmaptiles.org/Klokantech Noto Sans")}},X=function(t){return t.split(",").map(Number)},Y=function(t,e){var o=new f.a(t),n=Math.min.apply(Math,Object(d.a)(e.map((function(t){return t[1]})))),a=Math.max.apply(Math,Object(d.a)(e.map((function(t){return t[1]})))),i=Math.min.apply(Math,Object(d.a)(e.map((function(t){return t[0]})))),r=Math.max.apply(Math,Object(d.a)(e.map((function(t){return t[0]}))));return o.fitBounds([[n,i],[a,r]],{padding:{top:110,bottom:25,left:45,right:45}})},Z=function(){var t,e,o,n,r,c,l=Object(a.useRef)(null);Object(a.useEffect)((function(){if(l.current){var t=l.current.getMap();null===t||void 0===t||t.on("styleimagemissing",(function(e){var o=e.id;if(null===o||void 0===o?void 0:o.startsWith("icon-pin-")){var n=o.split("-"),a=Object(u.a)(n,5),i=a[2],r=a[3],c=a[4],l=function(t,e){return'\n<svg xmlns="http://www.w3.org/2000/svg"\n  width="'.concat(t,'px"\n  height="').concat(t,'px"\n  style="').concat(e,'"\n  viewBox="').concat("-1 -1 17 17",'"\n>\n  <path d="').concat(j,'" />\n</svg>')}(i,"fill: ".concat(r,"; stroke: ").concat(c));!function(t,e,o,n){var a=window.devicePixelRatio,i=document.createElement("canvas");i.width=a*n,i.height=a*n;var r=i.getContext("2d"),c=new Image(n,n),l="data:image/svg+xml,".concat(encodeURIComponent(o));c.onload=function(){if(!r)throw Error("canvas.getContext failed");r.drawImage(c,0,0,a*n,a*n),t.addImage(e,r.getImageData(0,0,a*n,a*n),{pixelRatio:a})},c.src=l}(t,o,l,i)}}))}}),[l]);var d=Object(p.e)({path:"/route/:from/:to"}),f=Object(a.useState)(V),T=Object(u.a)(f,2),k=T[0],M=T[1];Object(a.useEffect)((function(){var t,e,o,n;if(l.current){var a=null===(t=l.current.getMap())||void 0===t?void 0:null===(e=t.getContainer())||void 0===e?void 0:e.clientWidth,i=null===(o=l.current.getMap())||void 0===o?void 0:null===(n=o.getContainer())||void 0===n?void 0:n.clientHeight;if(d&&null!=a&&a>0&&null!=i&&i>0){var r=X(d.params.from),c=X(d.params.to),u=Object(s.a)({},k.viewport,{width:a,height:i}),p=Y(u,[r,c]);M((function(t){return Object(s.a)({},t,{origin:r,destination:J(c),viewport:Object(s.a)({},t.viewport,{},p)})}))}}}),[l]);var I=Object(p.d)();return Object(a.useEffect)((function(){var t=[k.destination.lat,k.destination.lon],e="/route/".concat(k.origin,"/").concat(t,"/");I.location.pathname!==e&&I.replace(e)}),[I,k.origin,k.destination]),Object(a.useEffect)((function(){(function(t){var e,o,n=new URL("https://overpass-api.de/api/interpreter");return n.searchParams.append("data",(e=t.lat,o=t.lon,"\n  [out:json][timeout:25];\n  (\n    relation(around:10, ".concat(e,", ").concat(o,")[building];\n    way(r);\n    way(around:10, ").concat(e,", ").concat(o,")[building];\n  )->.b;\n  // gather results\n  (\n    node(w.b)[entrance];\n  );\n  // print results\n  out body;\n  >;\n  out skel qt;\n"))),fetch(n.toString()).then((function(t){return t.json().then((function(t){return t.elements.filter((function(t){return"node"===t.type&&"lat"in t&&null!=t.lat&&"lon"in t&&null!=t.lon&&t.tags&&t.tags.entrance}))}))}))})(k.destination).then((function(t){M((function(e){if(e.destination!==k.destination)return e;var o=t.length?t:[k.destination];return Object(s.a)({},e,{entrances:o})}))}))}),[k.destination]),Object(a.useEffect)((function(){var t=[];k.entrances.forEach((function(e){k.destination.type===e.type&&k.destination.id===e.id&&(t=[e])})),t.length||(t=k.entrances),M((function(t){return Object(s.a)({},t,{route:U()})})),function(t,e,o){e.forEach((function(e){var n=new K;n.setProfileID("".concat("https","://").concat("/gatesolve-ui","/delivery.json")).query({from:{latitude:t[0],longitude:t[1]},to:{latitude:e.lat,longitude:e.lon}}).take(1).on("data",function(){var a=Object(L.a)(P.a.mark((function a(i){var r,c,l;return P.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,n.completePath(i);case 2:r=a.sent,console.log("Plan",r,"from",t,"to",e),c=H(r),l=U(t,[e],void 0,c),o(l);case 7:case"end":return a.stop()}}),a)})));return function(t){return a.apply(this,arguments)}}())}))}(k.origin,t,(function(t){M((function(e){if(k.origin!==e.origin||k.entrances!==e.entrances||k.destination!==e.destination)return e;var o=Object(s.a)({},t,{features:t.features.concat(e.route.features)});return Object(s.a)({},e,{route:o})}))}))}),[k.origin,k.entrances]),i.a.createElement("div",{"data-testid":"app",className:"App"},i.a.createElement("header",{className:"App-header"},i.a.createElement("h2",null,"Gatesolve")),i.a.createElement(m.ReactAutosuggestGeocoder,{url:"https://api.digitransit.fi/geocoding/v1/",sources:"oa,osm,nlsfi",center:{latitude:(null===(t=k.geolocationPosition)||void 0===t?void 0:t[0])||(null===(e=k.origin)||void 0===e?void 0:e[0])||(null===(o=k.destination)||void 0===o?void 0:o.lat)||$[0],longitude:(null===(n=k.geolocationPosition)||void 0===n?void 0:n[1])||(null===(r=k.origin)||void 0===r?void 0:r[1])||(null===(c=k.destination)||void 0===c?void 0:c.lon)||$[1]},onSuggestionSelected:function(t,e){var o=e.suggestion,n=[o.geometry.coordinates[1],o.geometry.coordinates[0]],a=o.properties.source_id.split(":"),i=Object(u.a)(a,2),r=i[0],c=i[1];M((function(t){var e=Y(t.viewport,[t.origin,n]);return Object(s.a)({},t,{origin:t.origin,destination:{lat:n[0],lon:n[1],type:r,id:Number(c)},entrances:[],viewport:Object(s.a)({},t.viewport,{},e)})}))}}),i.a.createElement(g.d,Object.assign({ref:l},k.viewport,{style:{width:"100%",height:"90%"},mapStyle:"https://raw.githubusercontent.com/HSLdevcom/hsl-map-style/master/simple-style.json",transformRequest:Q,onViewportChange:function(t){M((function(e){return Object(s.a)({},e,{viewport:t})}))},onHover:function(t){var e,o=null===(e=t.features)||void 0===e?void 0:e[0],n=(null===o||void 0===o?void 0:o.properties.entrance)?"pointer":"grab",a=document.querySelector(".overlays");a&&(a.style.cursor=n)},onClick:function(t){var e,o=null===(e=l.current)||void 0===e?void 0:e.getMap().queryRenderedFeatures(t.point)[0];M((function(e){return(null===o||void 0===o?void 0:o.properties.entrance)?Object(s.a)({},e,{destination:{id:o.properties["@id"],type:o.properties["@type"],lat:o.geometry.coordinates[1],lon:o.geometry.coordinates[0]}}):Object(s.a)({},e,{destination:J([t.lngLat.lat,t.lngLat.lng])})}))},onContextmenu:function(t){M((function(e){return Object(s.a)({},e,{origin:[t.lngLat.lat,t.lngLat.lng]})}))}}),i.a.createElement(S,{dataTestId:"geolocate-control",enableOnMount:!0,onEnable:function(){M((function(t){return Object(s.a)({},t,{isGeolocating:!0})}))},onDisable:function(){M((function(t){return Object(s.a)({},t,{isGeolocating:!1,geolocationPosition:null})}))},onGeolocate:function(t){M((function(e){if(e.isGeolocating){var o=Object(s.a)({},e,{geolocationPosition:[t.coords.latitude,t.coords.longitude]});return null==e.geolocationTimestamp||t.timestamp-e.geolocationTimestamp>1e4?Object(s.a)({},o,{origin:[t.coords.latitude,t.coords.longitude],geolocationTimestamp:t.timestamp}):o}return e}))}}),null!=k.geolocationPosition&&i.a.createElement(g.b,{offset:[-20,-20],longitude:k.geolocationPosition[1],latitude:k.geolocationPosition[0]},i.a.createElement(x,{dataTestId:"user-marker"})),i.a.createElement(g.c,{id:"osm-qa-tiles",type:"vector",tiles:["https://tile.olmap.org/osm-qa-tiles/{z}/{x}/{y}.pbf"],minzoom:12,maxzoom:12},i.a.createElement(g.a,Object.assign({"source-layer":"osm"},y,{source:"osm-qa-tiles"})),i.a.createElement(g.a,Object.assign({"source-layer":"osm"},O,{source:"osm-qa-tiles"}))),i.a.createElement(g.c,{id:"route",type:"geojson",data:k.route},i.a.createElement(g.a,Object.assign({},v,{source:"route"})),i.a.createElement(g.a,Object.assign({},h,{source:"route"})),i.a.createElement(g.a,Object.assign({},b,{source:"route"})),i.a.createElement(g.a,Object.assign({},w,{source:"route"}))),i.a.createElement(g.b,{className:"PinMarker",draggable:!0,offset:[0,-22.5],onDragEnd:function(t){M((function(e){return Object(s.a)({},e,{origin:[t.lat,t.lng]})}))},longitude:k.origin[1],latitude:k.origin[0]},i.a.createElement(E,{dataTestId:"origin",style:{fill:"#00afff",stroke:"#fff"}})),i.a.createElement(g.b,{className:"PinMarker",draggable:!0,offset:[0,-22.5],onDragEnd:function(t){M((function(e){return Object(s.a)({},e,{destination:J([t.lat,t.lng])})}))},longitude:k.destination.lon,latitude:k.destination.lat},i.a.createElement(E,{dataTestId:"destination",style:{fill:"#64be14",stroke:"#fff"}}))))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));c.a.render(i.a.createElement(i.a.StrictMode,null,i.a.createElement(l.a,null,i.a.createElement(Z,null))),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(t){t.unregister()})).catch((function(t){console.error(t.message)}))}},[[220,1,2]]]);
//# sourceMappingURL=main.ea64156f.chunk.js.map